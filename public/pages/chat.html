<div class="stack" x-cloak>
  <div class="mb-m">
    <h2 class="text-2xl font-semibold">AI Chat</h2>
    <p class="text-gray-600 mt-s">Chat with AI models</p>
  </div>
  <div x-show="lastChat && !chatStarted && lastChat.messages && lastChat.messages.length > 0" 
       @click="resumeLastChat()"
       class="card-interactive mb-m cursor-pointer">
    <div class="card-body">
      <div class="action-row mb-s">
        <h4 class="text-sm font-medium text-gray-700">Resume last chat</h4>
        <span class="text-xs text-gray-500" x-text="lastChat?.timestamp ? new Date(lastChat.timestamp).toLocaleString() : ''"></span>
      </div>
      <div class="max-h-[50vh] overflow-y-auto">
        <template x-for="(message, idx) in (lastChat?.messages || []).slice(-2)" :key="idx">
          <div class="mb-s" :class="message.role === 'user' ? 'text-right' : 'text-left'">
            <div class="inline-block max-w-3xl"
                 :class="message.role === 'user' ? 'bg-primary text-white' : 'bg-gray-100'"
                 class="rounded-lg p-3">
              <div x-show="message.role === 'assistant'" 
                   class="prose prose-sm max-w-none" 
                   x-html="renderMarkdown(message.content)"></div>
              <p x-show="message.role === 'user'" 
                 class="text-sm whitespace-pre-wrap" 
                 x-text="message.content"></p>
              
              <div x-show="message.role === 'assistant' && message.metadata" 
                   class="mt-s pt-s border-t border-gray-300">
                <div class="flex flex-wrap gap-s text-xs text-gray-600">
                  <span>ü§ñ <span x-text="message.metadata?.model || lastChat?.model"></span></span>
                  <span x-show="message.metadata?.online || lastChat?.enableOnlineSearch">üåê Online</span>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>
  <div x-show="chatStarted" x-transition class="card flex-1 mb-m">
    <div class="card-body flex flex-col h-full">
      <div class="flex justify-between items-center mb-m">
        <h3 class="text-lg font-semibold">Chat</h3>
        <button @click="clearChat()" class="btn btn-ghost btn-sm">Clear History</button>
      </div>
      <div class="flex-1 chat-messages mb-m stack-s">
        <template x-for="(message, index) in messages" :key="index">
          <div :class="message.role === 'user' ? 'text-right' : 'text-left'">
            <div class="inline-block max-w-3xl"
                 :class="message.role === 'user' ? 'bg-primary text-white' : 'bg-gray-100'"
                 class="rounded-lg p-3">
              <div x-show="!isRawFormat(index) && message.role === 'assistant'" 
                   class="prose prose-sm max-w-none" 
                   x-html="renderMarkdown(message.content)"></div>
              <p x-show="isRawFormat(index) || message.role === 'user'" 
                 class="text-sm whitespace-pre-wrap" 
                 x-text="message.content"></p>
              <div x-show="message.role === 'user' && message.attachments && message.attachments.length > 0" 
                   class="mt-s pt-s border-t" 
                   :class="message.role === 'user' ? 'border-blue-400' : 'border-gray-300'">
                <div class="flex flex-wrap gap-s">
                  <template x-for="attachment in message.attachments" :key="attachment.path">
                    <span class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded">
                      üìé <span x-text="attachment.name"></span>
                    </span>
                  </template>
                </div>
              </div>
              <div x-show="message.role === 'assistant' && message.metadata" 
                   class="mt-s pt-s border-t" 
                   :class="message.role === 'user' ? 'border-blue-400' : 'border-gray-300'">
                <div class="flex flex-wrap gap-s text-xs items-center" 
                     :class="message.role === 'user' ? 'text-blue-100' : 'text-gray-600'">
                  <span>ü§ñ <span x-text="message.metadata?.model"></span></span>
                  <span x-show="message.metadata?.online">üåê Online</span>
                  <span>üí∞ $<span x-text="message.metadata?.cost?.toFixed(4) || '0'"></span></span>
                  <span>üî§ <span x-text="message.metadata?.tokens || '0'"></span> tokens</span>
                  <span>‚è±Ô∏è <span x-text="message.metadata?.timestamp ? new Date(message.metadata.timestamp).toLocaleTimeString() : ''"></span></span>
                  <button @click="toggleMessageFormat(index)"
                          class="ml-auto px-2 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-700">
                    <span x-text="isRawFormat(index) ? 'MD' : 'Raw'"></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </template>
        
        <div x-show="isLoading" class="text-left">
          <div class="inline-block bg-gray-100 rounded-lg p-3">
            <div class="flex items-center gap-s">
              <div class="spinner-inline"></div>
              <span class="meta-text">AI is thinking...</span>
            </div>
          </div>
        </div>
      </div>
      <div x-show="attachedFiles && attachedFiles.length > 0" class="mb-s">
        <div class="flex flex-wrap gap-s">
          <template x-for="(file, index) in (attachedFiles || [])" :key="index">
            <div class="bg-gray-100 rounded-lg px-3 py-2 flex items-center gap-s">
              <span class="text-sm" x-text="file.name"></span>
              <button @click="removeAttachment(index)" class="text-red-500 hover:text-red-700">
                √ó
              </button>
            </div>
          </template>
        </div>
      </div>
      <form @submit.prevent="sendMessage()" class="chat-input-area">
        <div class="flex gap-s">
          <textarea x-model="newMessage"
                    @keydown.enter.prevent="if (!$event.shiftKey) sendMessage()"
                    placeholder="Type your message..."
                    class="form-textarea flex-1"
                    rows="3"
                    :disabled="isLoading"></textarea>
          <div class="flex flex-col gap-s">
            <button type="button"
                    @click="showFilePicker = true"
                    class="btn btn-secondary"
                    title="Attach files">
              üìé
            </button>
            <button type="submit" 
                    :disabled="!newMessage.trim() || isLoading" 
                    class="btn btn-primary">
              Send
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div class="card" :class="!showModelSelector && chatStarted ? 'cursor-pointer' : ''"
       @click="!showModelSelector && chatStarted ? toggleModelSelector() : null">
    <div class="card-body">
      <div class="flex justify-between items-center mb-m">
        <h3 class="text-lg font-semibold">
          <template x-if="!chatStarted">
            <span>Select Model</span>
          </template>
          <template x-if="chatStarted && showModelSelector">
            <span>Change Model</span>
          </template>
          <template x-if="chatStarted && !showModelSelector">
            <span>
              Current: <span x-text="selectedModel?.name" class="text-primary"></span>
              <span x-show="enableOnlineSearch" class="text-primary text-sm">üåê</span>
            </span>
          </template>
        </h3>
        <button x-show="chatStarted" 
                @click.stop="toggleModelSelector()" 
                class="btn btn-ghost btn-sm">
          <span x-text="showModelSelector ? '‚ñ≤' : '‚ñº'"></span>
        </button>
      </div>
      <div x-show="showModelSelector" x-transition class="model-selector">
        <div class="mb-4">
          <div class="search-box mb-3">
            <input 
              type="text" 
              class="form-input" 
              placeholder="Search models..."
              x-model="modelSearch"
            >
          </div>
          <div class="mb-3">
            <div class="text-sm text-gray-600 mb-2">Quick Filters:</div>
            <div class="flex flex-wrap gap-2">
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'all' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('all')"
              >
                üåê All Models
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'free' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('free')"
              >
                üÜì Free
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'cheap' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('cheap')"
              >
                üí∞ Cheap (<$0.001)
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'fast' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('fast')"
              >
                ‚ö° Fast
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'smart' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('smart')"
              >
                üß† Smart (GPT-4/Claude)
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'multimodal' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('multimodal')"
              >
                üñºÔ∏è Multimodal
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'large-context' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('large-context')"
              >
                üìö 100K+ Context
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'coding' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('coding')"
              >
                üíª Coding
              </button>
              <div class="inline-block ml-3">
                <label class="toggle-label">
                  <div class="toggle-switch">
                    <input 
                      type="checkbox" 
                      x-model="enableOnlineSearch"
                    >
                    <span class="toggle-slider"></span>
                  </div>
                  <span>üîç Online Search</span>
                </label>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <div class="mt-3 space-y-3">
              <div>
                <div class="text-sm text-gray-600 mb-2">Provider:</div>
                <div class="flex flex-wrap gap-2">
                  <button @click="toggleFilter('provider', 'openai')"
                          :class="isFilterActive('provider', 'openai') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    OpenAI
                  </button>
                  <button @click="toggleFilter('provider', 'anthropic')"
                          :class="isFilterActive('provider', 'anthropic') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    Anthropic
                  </button>
                  <button @click="toggleFilter('provider', 'google')"
                          :class="isFilterActive('provider', 'google') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    Google
                  </button>
                  <button @click="toggleFilter('provider', 'meta')"
                          :class="isFilterActive('provider', 'meta') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    Meta
                  </button>
                  <button @click="toggleFilter('provider', 'mistral')"
                          :class="isFilterActive('provider', 'mistral') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    Mistral
                  </button>
                  <button @click="toggleFilter('provider', 'perplexity')"
                          :class="isFilterActive('provider', 'perplexity') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    Perplexity
                  </button>
                </div>
              </div>
              <div>
                <div class="text-sm text-gray-600 mb-2">Capabilities:</div>
                <div class="flex flex-wrap gap-2">
                  <button @click="toggleFilter('capabilities', 'function-calling')"
                          :class="isFilterActive('capabilities', 'function-calling') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    üîß Function Calling
                  </button>
                  <button @click="toggleFilter('capabilities', 'json-mode')"
                          :class="isFilterActive('capabilities', 'json-mode') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    üìã JSON Mode
                  </button>
                  <button @click="toggleFilter('capabilities', 'web-search')"
                          :class="isFilterActive('capabilities', 'web-search') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    üîç Web Search
                  </button>
                  <button @click="toggleFilter('capabilities', 'vision')"
                          :class="isFilterActive('capabilities', 'vision') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    üëÅÔ∏è Vision
                  </button>
                </div>
              </div>
              <div>
                <div class="text-sm text-gray-600 mb-2">Context Size:</div>
                <div class="flex flex-wrap gap-2">
                  <button @click="toggleFilter('context', '4k')"
                          :class="isFilterActive('context', '4k') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    4K
                  </button>
                  <button @click="toggleFilter('context', '8k')"
                          :class="isFilterActive('context', '8k') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    8K
                  </button>
                  <button @click="toggleFilter('context', '16k')"
                          :class="isFilterActive('context', '16k') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    16K
                  </button>
                  <button @click="toggleFilter('context', '32k')"
                          :class="isFilterActive('context', '32k') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    32K
                  </button>
                  <button @click="toggleFilter('context', '128k+')"
                          :class="isFilterActive('context', '128k+') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    128K+
                  </button>
                </div>
              </div>
              <div x-show="hasActiveFilters()" class="pt-2">
                <button @click="clearAllFilters()" class="btn btn-ghost btn-sm">
                  ‚ùå Clear All Filters
                </button>
              </div>
            </div>
          </div>
          <div class="mt-4">
            <button @click="chatStarted = true; showModelSelector = false; startOrChangeChat()" 
                    :disabled="!selectedModel"
                    x-show="!chatStarted || showModelSelector"
                    class="btn btn-primary w-full">
              <span x-show="!chatStarted">Start Chat</span>
              <span x-show="chatStarted">Apply Model Change</span>
            </button>
          </div>
        </div>
        <div class="text-center py-8" x-show="isLoading">
          <div class="spinner"></div>
          <p class="text-muted mt-2">Loading models...</p>
        </div>
        <div class="models-grid" x-show="!isLoading">
          <template x-for="model in filteredModels" :key="model.id">
            <div 
              class="card-interactive"
              :class="selectedModel?.id === model.id ? 'selected' : ''"
              @click="selectModel(model)"
            >
              <div class="model-header">
                <h4 class="model-name" x-text="model.name"></h4>
                <span class="model-provider text-muted" x-text="getProviderName(model)"></span>
              </div>
              <div class="model-info">
                <div class="info-row">
                  <span class="label">Context:</span>
                  <span class="value" x-text="formatContext(model.context_length)"></span>
                </div>
                <div class="info-row">
                  <span class="label">Price:</span>
                  <span class="value" x-text="formatPrice(model.pricing)"></span>
                </div>
              </div>
              <div class="model-tags">
                <span class="tag tag-blue" x-show="!model.pricing || (model.pricing.prompt === 0 && model.pricing.completion === 0)">
                  Free
                </span>
                <span class="tag tag-green" x-show="model.input_modalities?.includes('image') || model.input_modalities?.includes('audio')">
                  Multimodal
                </span>
                <span class="tag tag-purple" x-show="model.context_length >= 100000">
                  Large Context
                </span>
              </div>
            </div>
          </template>
        </div>
        <div class="text-center py-8" x-show="!isLoading && filteredModels.length === 0">
          <p class="text-muted">No models found matching your criteria</p>
        </div>
      </div>
    </div>
  </div>
  <div x-show="showFilePicker" 
       @click.away="showFilePicker = false"
       x-transition
       class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col" @click.stop>
      <div class="p-m border-b">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold">Attach Files</h3>
          <button @click="showFilePicker = false" class="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>
      </div>
      
      <div class="flex-1 overflow-y-auto p-m">
        <div class="mb-m">
          <div class="flex gap-s">
            <button @click="filePickerTab = 'uploads'; loadFilesForTab()"
                    :class="filePickerTab === 'uploads' ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'">
              My Uploads
            </button>
            <button @click="filePickerTab = 'configs'; loadFilesForTab()"
                    :class="filePickerTab === 'configs' ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'">
              Configurations
            </button>
            <button @click="filePickerTab = 'outputs'; loadFilesForTab()"
                    :class="filePickerTab === 'outputs' ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'">
              Generated Output
            </button>
          </div>
        </div>
        <div x-show="filePickerTab === 'uploads'" class="mb-m">
          <div class="card p-m bg-gray-50">
            <div class="mb-s">
              <label class="block text-sm font-medium mb-s">Upload New File</label>
              <input type="file" @change="handleFileUpload($event)" class="form-input" :disabled="isUploading">
            </div>
            <div x-show="storageInfo" class="text-xs text-gray-600">
              Storage: <span x-text="formatBytes(storageInfo?.used || 0)"></span> / <span x-text="formatBytes(storageInfo?.quota || 0)"></span> used
            </div>
            <div x-show="isUploading" class="mt-s">
              <div class="flex items-center gap-s">
                <div class="spinner-inline"></div>
                <span class="text-sm text-gray-600">Uploading...</span>
              </div>
            </div>
          </div>
        </div>
        <div class="stack-s">
          <div x-show="isLoadingFiles" class="text-center py-4">
            <div class="spinner-inline"></div>
          </div>
          
          <template x-for="file in (availableFiles || [])" :key="file.path">
            <div @click="toggleFileSelection(file)"
                 class="card-interactive p-s"
                 :class="isFileSelected(file) ? 'border-primary bg-blue-50' : ''">
              <div class="flex justify-between items-center">
                <div>
                  <div class="font-medium text-sm" x-text="file.name"></div>
                  <div class="text-xs text-gray-600">
                    <span x-text="formatBytes(file.size)"></span> ‚Ä¢ 
                    <span x-text="new Date(file.modified).toLocaleDateString()"></span>
                  </div>
                </div>
                <div x-show="isFileSelected(file)" class="text-primary">‚úì</div>
              </div>
            </div>
          </template>
          
          <div x-show="!isLoadingFiles && (!availableFiles || availableFiles.length === 0)" class="text-center py-4 text-gray-500">
            No files available in this category
          </div>
        </div>
      </div>
      
      <div class="p-m border-t">
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">
            <span x-text="(selectedFiles || []).length"></span> file(s) selected
          </span>
          <div class="flex gap-s">
            <button @click="showFilePicker = false" class="btn btn-ghost">Cancel</button>
            <button @click="attachSelectedFiles()" 
                    :disabled="!selectedFiles || selectedFiles.length === 0"
                    class="btn btn-primary">Attach Files</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>