<div class="stack">
  <div class="mb-m">
    <h2 class="text-2xl font-semibold" x-text="$store.i18n.t('generation.dataGenerator')"></h2>
    <p class="text-gray-600 mt-s" x-text="$store.i18n.t('generation.generateStructuredData')"></p>
  </div>
  <div class="flex items-center justify-between mb-l">
    <div class="flex items-center">
      <div class="progress-indicator"
           :class="step > 1 ? 'progress-indicator-completed' : step === 1 ? 'progress-indicator-active' : 'progress-indicator-pending'">1</div>
      <span class="text-sm ml-s whitespace-nowrap" 
            :class="step === 1 ? 'text-primary font-medium' : 'text-gray-500'"
            x-text="$store.i18n.t('generation.selectConfig')"></span>
    </div>
    <div class="progress-connector flex-1 mx-m"
         :class="step > 1 ? 'progress-connector-completed' : ''"></div>
    
    <div class="flex items-center">
      <div class="progress-indicator"
           :class="step > 2 ? 'progress-indicator-completed' : step === 2 ? 'progress-indicator-active' : 'progress-indicator-pending'">2</div>
      <span class="text-sm ml-s whitespace-nowrap" 
            :class="step === 2 ? 'text-primary font-medium' : 'text-gray-500'"
            x-text="$store.i18n.t('generation.selectModel')"></span>
    </div>
    <div class="progress-connector flex-1 mx-m"
         :class="step > 2 ? 'progress-connector-completed' : ''"></div>
    
    <div class="flex items-center">
      <div class="progress-indicator"
           :class="step > 3 ? 'progress-indicator-completed' : step === 3 ? 'progress-indicator-active' : 'progress-indicator-pending'">3</div>
      <span class="text-sm ml-s whitespace-nowrap" 
            :class="step === 3 ? 'text-primary font-medium' : 'text-gray-500'"
            x-text="$store.i18n.t('generation.confirm')"></span>
    </div>
  </div>
  <div x-show="step === 1" class="card">
    <div class="card-body">
      <h3 class="text-lg font-semibold mb-m" x-text="$store.i18n.t('generation.selectConfiguration')"></h3>
      <div x-show="!hasConfigParam" class="empty-state">
        <p class="text-gray-600 mb-m" x-text="$store.i18n.t('generation.selectConfigFromFileManager')"></p>
        <a href="#/files" class="btn btn-primary" x-text="$store.i18n.t('generation.goToFileManager')"></a>
      </div>
      <div x-show="hasConfigParam" class="flex flex-col items-center justify-center py-l">
        <div class="spinner mb-m"></div>
        <p class="text-gray-600" x-text="$store.i18n.t('generation.loadingConfiguration')"></p>
      </div>
    </div>
  </div>
  <div x-show="step === 2" class="card">
    <div class="card-body">
      <h3 class="text-lg font-semibold mb-m" x-text="$store.i18n.t('generation.selectAiModel')"></h3>
      <div x-show="configModel" class="mb-m">
        <p class="meta-text mb-s">
          <span x-text="$store.i18n.t('generation.configurationUses')"></span>
          <span x-show="configModel && configModel.endsWith(':online')" class="ml-1">üåê</span>
        </p>
        <template x-if="configModelObject">
          <div class="card p-m" :class="selectedModel?.id === configModelObject.id ? 'border-primary' : ''">
            <div class="flex justify-between">
              <div class="flex-1">
                <div class="flex justify-between items-start mb-s">
                  <h4 class="font-medium text-sm ">
                    <span x-text="configModelObject.name"></span>
                    <span x-show="configModel && configModel.endsWith(':online')" class="ml-1">üåê</span>
                  </h4>
                  <span class="text-xs text-gray-500 ml-s" x-text="getProviderName(configModelObject)"></span>
                </div>
                <div class="flex flex-wrap gap-s mb-s">
                  <template x-for="badge in getModelBadges(configModelObject)" :key="badge.label">
                    <span :class="badge.class" class="badge text-xs " x-text="badge.label"></span>
                  </template>
                </div>
                <div class="text-xs text-gray-600">
                  <div class="flex items-center gap-s flex-wrap">
                    <div x-show="configModelObject.max_completion_tokens" class="flex items-center gap-s">
                      <span class="text-gray-500" x-text="$store.i18n.t('forms.maxTokens') + ':'"></span>
                      <span x-text="configModelObject.max_completion_tokens?.toLocaleString() + ' tokens'"></span>
                    </div>
                    <div x-show="configModelObject.input_modalities?.length > 0 || configModelObject.output_modalities?.length > 0" class="text-gray-500">
                      <span x-text="formatModalities(configModelObject.input_modalities, configModelObject.output_modalities)"></span>
                    </div>
                  </div>
                  <div class="flex justify-between mt-s">
                    <template x-if="(configModelObject.pricing?.prompt || 0) < 0">
                      <span class="text-gray-500 col-span-2" x-text="$store.i18n.t('models.autoRouting')"></span>
                    </template>
                    <template x-if="(configModelObject.pricing?.prompt || 0) >= 0">
                      <>
                        <span class="text-gray-500">$<span x-text="((configModelObject.pricing?.prompt || 0) * 1000).toFixed(3)"></span>/1K in</span>
                        <span class="text-gray-500">$<span x-text="((configModelObject.pricing?.completion || 0) * 1000).toFixed(3)"></span>/1K out</span>
                      </>
                    </template>
                  </div>
                  <div x-show="configModelObject.supports_web_search" class="mt-s">
                    <template x-if="getWebSearchPricing(configModelObject)">
                      <span class="text-xs text-primary">
                        <span x-text="getWebSearchPricing(configModelObject).label"></span>: 
                        $<span x-text="getWebSearchPricing(configModelObject).price.toFixed(2)"></span>/1K requests
                      </span>
                    </template>
                  </div>
                </div>
              </div>
              <div class="ml-m flex flex-col gap-s">
                <button x-show="!selectedModel || selectedModel.id !== configModelObject.id" 
                        @click="selectedModel = configModelObject; enableOnlineSearch = configModel.endsWith(':online'); if(selectedModel) nextStep()" 
                        class="btn btn-primary btn-sm">
                  <span x-text="$store.i18n.t('buttons.useThisModel')"></span>
                </button>
                <button x-show="selectedModel && selectedModel.id === configModelObject.id" 
                        @click="nextStep()" 
                        class="btn btn-primary btn-sm">
                  <span x-text="$store.i18n.t('common.continue')"></span> ‚Üí
                </button>
              </div>
            </div>
          </div>
        </template>
        <div class="mt-m meta-text" x-text="$store.i18n.t('generation.orSelectDifferent')"></div>
      </div>
      <div class="model-selector">
        <div class="mb-4">
          <div class="search-box mb-3">
            <input 
              type="text" 
              class="form-input" 
              :placeholder="$store.i18n.t('placeholders.searchModels')"
              x-model="modelSearch"
            >
          </div>
          <div class="mb-3">
            <div class="text-sm text-gray-600 mb-2"><span x-text="$store.i18n.t('forms.quickFilters')"></span>:</div>
            <div class="flex flex-wrap gap-2">
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'all' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('all')"
              >
                <span x-text="$store.i18n.t('models.allModels')"></span>
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'free' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('free')"
              >
                üÜì <span x-text="$store.i18n.t('models.free')"></span>
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'cheap' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('cheap')"
              >
                üí∞ <span x-text="$store.i18n.t('models.cheap')"></span>
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'fast' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('fast')"
              >
                ‚ö° <span x-text="$store.i18n.t('models.fast')"></span>
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'smart' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('smart')"
              >
                üß† <span x-text="$store.i18n.t('models.smart')"></span>
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'multimodal' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('multimodal')"
              >
                üñºÔ∏è <span x-text="$store.i18n.t('models.multimodal')"></span>
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'large-context' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('large-context')"
              >
                üìö <span x-text="$store.i18n.t('models.largeContext')"></span>
              </button>
              <button 
                class="btn btn-sm"
                :class="modelFilter === 'coding' ? 'btn-primary' : 'btn-secondary'"
                @click="setModelFilter('coding')"
              >
                üíª <span x-text="$store.i18n.t('models.coding')"></span>
              </button>
            </div>
          </div>
          <div class="mb-3">
            <div class="mt-3 space-y-3">
              <div>
                <div class="text-sm text-gray-600 mb-2"><span x-text="$store.i18n.t('models.provider')"></span>:</div>
                <div class="flex flex-wrap gap-2">
                  <button @click="toggleFilter('provider', 'openai')"
                          :class="isFilterActive('provider', 'openai') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>OpenAI</span>
                  </button>
                  <button @click="toggleFilter('provider', 'anthropic')"
                          :class="isFilterActive('provider', 'anthropic') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>Anthropic</span>
                  </button>
                  <button @click="toggleFilter('provider', 'google')"
                          :class="isFilterActive('provider', 'google') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>Google</span>
                  </button>
                  <button @click="toggleFilter('provider', 'meta')"
                          :class="isFilterActive('provider', 'meta') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>Meta</span>
                  </button>
                  <button @click="toggleFilter('provider', 'mistral')"
                          :class="isFilterActive('provider', 'mistral') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>Mistral</span>
                  </button>
                  <button @click="toggleFilter('provider', 'perplexity')"
                          :class="isFilterActive('provider', 'perplexity') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>Perplexity</span>
                  </button>
                </div>
              </div>
              <div>
                <div class="text-sm text-gray-600 mb-2"><span x-text="$store.i18n.t('models.capabilities')"></span>:</div>
                <div class="flex flex-wrap gap-2">
                  <button @click="toggleFilter('capabilities', 'function-calling')"
                          :class="isFilterActive('capabilities', 'function-calling') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    üîß <span x-text="$store.i18n.t('models.functionCalling')"></span>
                  </button>
                  <button @click="toggleFilter('capabilities', 'json-mode')"
                          :class="isFilterActive('capabilities', 'json-mode') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    üìã <span x-text="$store.i18n.t('models.jsonMode')"></span>
                  </button>
                  <button @click="toggleFilter('capabilities', 'web-search')"
                          :class="isFilterActive('capabilities', 'web-search') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    üîç <span x-text="$store.i18n.t('models.webSearch')"></span>
                  </button>
                  <button @click="toggleFilter('capabilities', 'vision')"
                          :class="isFilterActive('capabilities', 'vision') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    üëÅÔ∏è <span x-text="$store.i18n.t('models.vision')"></span>
                  </button>
                </div>
              </div>
              <div>
                <div class="text-sm text-gray-600 mb-2"><span x-text="$store.i18n.t('models.contextSize')"></span>:</div>
                <div class="flex flex-wrap gap-2">
                  <button @click="toggleFilter('context', '4k')"
                          :class="isFilterActive('context', '4k') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>4K</span>
                  </button>
                  <button @click="toggleFilter('context', '8k')"
                          :class="isFilterActive('context', '8k') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>8K</span>
                  </button>
                  <button @click="toggleFilter('context', '16k')"
                          :class="isFilterActive('context', '16k') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>16K</span>
                  </button>
                  <button @click="toggleFilter('context', '32k')"
                          :class="isFilterActive('context', '32k') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>32K</span>
                  </button>
                  <button @click="toggleFilter('context', '128k+')"
                          :class="isFilterActive('context', '128k+') ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm'"
                          class="text-xs">
                    <span>128K+</span>
                  </button>
                </div>
              </div>
              <div x-show="hasActiveFilters()" class="pt-2">
                <button @click="clearAllFilters()" class="btn btn-ghost btn-sm">
                  ‚ùå <span x-text="$store.i18n.t('models.clearAllFilters')"></span>
                </button>
              </div>
            </div>
          </div>
          <div class="mt-4">
            <button @click="nextStep()" :disabled="!selectedModel" class="btn btn-primary w-full">
              <span x-text="$store.i18n.t('buttons.applyModel')"></span> ‚Üí
            </button>
          </div>
        </div>
        <div class="text-center py-8" x-show="isLoading">
          <div class="spinner"></div>
          <p class="text-muted mt-2" x-text="$store.i18n.t('models.loadingModels')"></p>
        </div>
        <div class="models-grid" x-show="!isLoading">
          <template x-for="model in filteredModels" :key="model.id">
            <div 
              class="card-interactive"
              :class="selectedModel?.id === model.id ? 'selected' : ''"
              @click="selectModel(model)"
            >
              <div class="model-header">
                <h4 class="model-name" x-text="model.name"></h4>
                <span class="model-provider text-muted" x-text="getProviderName(model)"></span>
              </div>
              <div class="model-info">
                <div class="info-row">
                  <span class="label" x-text="$store.i18n.t('models.context') + ':'"></span>
                  <span class="value" x-text="formatContext(model.context_length)"></span>
                </div>
                <div class="info-row">
                  <span class="label" x-text="$store.i18n.t('models.price') + ':'"></span>
                  <span class="value" x-text="formatPrice(model.pricing)"></span>
                </div>
              </div>
              <div class="model-tags">
                <span class="tag tag-blue" x-show="!model.pricing || (model.pricing.prompt === 0 && model.pricing.completion === 0)">
                  <span x-text="$store.i18n.t('models.free')"></span>
                </span>
                <span class="tag tag-green" x-show="model.input_modalities?.includes('image') || model.input_modalities?.includes('audio')">
                  <span x-text="$store.i18n.t('models.multimodal')"></span>
                </span>
                <span class="tag tag-purple" x-show="model.context_length >= 100000">
                  <span x-text="$store.i18n.t('models.largeContext')"></span>
                </span>
              </div>
            </div>
          </template>
        </div>
        <div class="text-center py-8" x-show="!isLoading && filteredModels.length === 0">
          <p class="text-muted" x-text="$store.i18n.t('models.noModelsFound')"></p>
        </div>
        
      </div>
      
      <div class="flex justify-between mt-l">
        <button @click="prevStep()" class="btn btn-ghost">‚Üê <span x-text="$store.i18n.t('buttons.back')"></span></button>
      </div>
    </div>
  </div>
  <div x-show="step === 3" class="card">
    <div class="card-body">
      <h3 class="text-lg font-semibold mb-m" x-text="$store.i18n.t('generation.confirmGeneration')"></h3>
      
      <div class="stack-m">
        <div class="card-sectioned">
          <div class="card-header">
            <h4 class="font-semibold" x-text="$store.i18n.t('generation.configurationDetails')"></h4>
          </div>
          <div class="card-body">
            <div class="grid-2 gap-m">
              <div>
                <div class="meta-text" x-text="$store.i18n.t('generation.configurationFile')"></div>
                <div class="font-medium" x-text="selectedConfig?.name"></div>
              </div>
              <div>
                <div class="meta-text" x-text="$store.i18n.t('generation.outputFormat')"></div>
                <div class="font-medium" x-text="configContent?.output?.format || 'json'"></div>
              </div>
              <div x-show="configContent?.meta?.description">
                <div class="meta-text" x-text="$store.i18n.t('forms.description')"></div>
                <div class="font-medium" x-text="configContent?.meta?.description"></div>
              </div>
              <div x-show="configContent?.generation?.tasks">
                <div class="meta-text" x-text="$store.i18n.t('generation.generationTasks')"></div>
                <div class="font-medium" x-text="configContent?.generation?.tasks?.length + ' tasks'"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-sectioned">
          <div class="card-header">
            <h4 class="font-semibold" x-text="$store.i18n.t('generation.modelConfiguration')"></h4>
          </div>
          <div class="card-body">
            <div class="grid-2 gap-m">
              <div>
                <div class="meta-text" x-text="$store.i18n.t('generation.selectedModel')"></div>
                <div class="font-medium" x-text="selectedModel?.name"></div>
              </div>
              <div>
                <div class="meta-text" x-text="$store.i18n.t('models.provider')"></div>
                <div class="font-medium" x-text="getProviderName(selectedModel)"></div>
              </div>
              <div>
                <div class="meta-text" x-text="$store.i18n.t('forms.temperature')"></div>
                <div class="font-medium" x-text="parameters.temperature"></div>
              </div>
              <div>
                <div class="meta-text" x-text="$store.i18n.t('forms.maxTokens')"></div>
                <div class="font-medium" x-text="parameters.maxTokens?.toLocaleString()"></div>
              </div>
              <div x-show="enableOnlineSearch">
                <div class="meta-text" x-text="$store.i18n.t('models.webSearch')"></div>
                <div class="font-medium text-primary" x-text="$store.i18n.t('generation.webSearchEnabled')"></div> üåê
              </div>
              <div>
                <div class="meta-text" x-text="$store.i18n.t('generation.totalItems')"></div>
                <div class="font-medium" x-text="parameters.count"></div>
              </div>
            </div>
          </div>
        </div>
        <div x-show="getEstimatedCost()" class="alert alert-warning">
          <div>
            <p class="font-medium mb-s">üí∞ <span x-text="$store.i18n.t('generation.estimatedCost')"></span></p>
            <div class="grid gap-m mt-s" :class="enableOnlineSearch && selectedModel?.supports_web_search ? 'grid-4' : 'grid-3'">
              <div>
                <div class="text-xs" x-text="$store.i18n.t('generation.input')"></div>
                <div class="font-medium">$<span x-text="getEstimatedCost()?.prompt"></span></div>
              </div>
              <div>
                <div class="text-xs" x-text="$store.i18n.t('generation.output')"></div>
                <div class="font-medium">$<span x-text="getEstimatedCost()?.completion"></span></div>
              </div>
              <div x-show="enableOnlineSearch && selectedModel?.supports_web_search">
                <div class="text-xs" x-text="$store.i18n.t('models.webSearch')"></div>
                <div class="font-medium">$<span x-text="getEstimatedCost()?.webSearch"></span></div>
              </div>
              <div>
                <div class="text-xs" x-text="$store.i18n.t('generation.total')"></div>
                <div class="font-bold text-lg">$<span x-text="getEstimatedCost()?.total"></span></div>
              </div>
            </div>
          </div>
        </div>
        <div class="meta-text text-center">
          <p x-text="$store.i18n.t('generation.readyToGenerate', { count: parameters.count, model: selectedModel?.name })"></p>
          <p class="mt-s" x-text="$store.i18n.t('generation.resultsSavedTo')"></p>
        </div>
      </div>
      
      <div class="flex justify-between mt-l">
        <button @click="prevStep()" class="btn btn-ghost">‚Üê <span x-text="$store.i18n.t('buttons.back')"></span></button>
        <button @click="startGeneration()" class="btn btn-primary">
          ‚ú® <span x-text="$store.i18n.t('buttons.startGeneration')"></span>
        </button>
      </div>
    </div>
  </div>
  
</div>